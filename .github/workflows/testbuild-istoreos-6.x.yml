name: testBuild iStore OS 6.x

on:
  push:
    paths:
      - '.last_version'
  workflow_dispatch:
    inputs:
      version:
        description: 'iStoreOS version'
        required: false
      date:
        description: 'Build date'
        required: false

env:
  REPO_URL: https://github.com/istoreos/istoreos
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: .config
  DIY_P1_SH: diy/diy-6.x-part1.sh
  DIY_P2_SH: diy/diy-6.x-part2.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        REPO_BRANCH:
          - istoreos-24.10
        ARCHITECTURE:
          - armv8
        os:
          - ubuntu-22.04
      fail-fast: false

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: 读取版本信息
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
          DATE="${{ github.event.inputs.date }}"
        else
          VERSION_LINE=$(cat .last_version)
          VERSION=$(echo "$VERSION_LINE" | cut -d'-' -f1)
          DATE=$(echo "$VERSION_LINE" | cut -d'-' -f2)
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "DATE=$DATE" >> $GITHUB_ENV
        echo "Parsed VERSION=$VERSION, DATE=$DATE"

    # 这里继续保留你原来的编译、打包、上传、发布步骤
    # 生成发布标签时直接用 ${{ env.VERSION }} 和 ${{ env.DATE }}

    - name: 生成发布标签
      id: tag
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        BUILD_TIME=$(date +"%Y%m%d%H%M")
        RELEASE_TAG="v${VERSION}-${DATE}-${BUILD_TIME}"
        echo "release_tag=$RELEASE_TAG" >> ${GITHUB_OUTPUT}

        touch release.txt
        echo "
        🖥️ Architecture: rockchip-${{ matrix.ARCHITECTURE }}

        🔀 Branch: ${{ matrix.REPO_BRANCH }}

        📂 Source Code: ${{ env.REPO_URL }}

        📦 Version: ${VERSION}
        📅 Release Date: ${DATE}
        🕒 Build Time: $(date +"%Y-%m-%d %H:%M") " >> release.txt

        echo "status=success" >> ${GITHUB_OUTPUT}
