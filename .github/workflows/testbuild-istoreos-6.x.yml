name: testBuild iStore OS 6.x

on:
  push:
    paths:
      - '.last_version'
  workflow_dispatch:
    inputs:
      version:
        description: 'iStoreOS version'
        required: false
      date:
        description: 'Build date'
        required: false

env:
  REPO_URL: https://github.com/istoreos/istoreos
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: .config
  DIY_P1_SH: diy/diy-6.x-part1.sh
  DIY_P2_SH: diy/diy-6.x-part2.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        REPO_BRANCH:
          - istoreos-24.10
        ARCHITECTURE:
          - armv8
        os:
          - ubuntu-22.04
      fail-fast: false

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
          DATE="${{ github.event.inputs.date }}"
        else
          VERSION_LINE=$(cat .last_version)
          VERSION=$(echo "$VERSION_LINE" | cut -d'-' -f1)
          DATE=$(echo "$VERSION_LINE" | cut -d'-' -f2)
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "DATE=$DATE" >> $GITHUB_ENV
        echo "Parsed VERSION=$VERSION, DATE=$DATE"

    # è¿™é‡Œç»§ç»­ä¿ç•™ä½ åŽŸæ¥çš„ç¼–è¯‘ã€æ‰“åŒ…ã€ä¸Šä¼ ã€å‘å¸ƒæ­¥éª¤
    # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾æ—¶ç›´æŽ¥ç”¨ ${{ env.VERSION }} å’Œ ${{ env.DATE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        BUILD_TIME=$(date +"%Y%m%d%H%M")
        RELEASE_TAG="v${VERSION}-${DATE}-${BUILD_TIME}"
        echo "release_tag=$RELEASE_TAG" >> ${GITHUB_OUTPUT}

        touch release.txt
        echo "
        ðŸ–¥ï¸ Architecture: rockchip-${{ matrix.ARCHITECTURE }}

        ðŸ”€ Branch: ${{ matrix.REPO_BRANCH }}

        ðŸ“‚ Source Code: ${{ env.REPO_URL }}

        ðŸ“¦ Version: ${VERSION}
        ðŸ“… Release Date: ${DATE}
        ðŸ•’ Build Time: $(date +"%Y-%m-%d %H:%M") " >> release.txt

        echo "status=success" >> ${GITHUB_OUTPUT}
